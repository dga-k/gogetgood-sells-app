<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å - ‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡∏ö‡∏π‡∏ò</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../config.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background: #f8fafc; margin: 0; padding: 10px; color: #334155; }
        .container { max-width: 900px; margin: auto; }
        
        .header-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        h2 { margin: 0; font-size: 1.25rem; }

        .btn { padding: 10px 16px; border-radius: 12px; font-weight: bold; text-decoration: none; font-size: 0.9rem; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; border: none; }
        .btn-report { background: #f59e0b; color: white; }
        .btn-transfer { background: white; color: #475569; border: 1px solid #e2e8f0; width: 100%; justify-content: center; margin-bottom: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        .filter-bar { background: white; padding: 15px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .filter-bar label { display: block; font-size: 0.8rem; font-weight: bold; color: #64748b; margin-bottom: 8px; text-transform: uppercase; }
        select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #e2e8f0; font-size: 1rem; background-color: #f1f5f9; }

        /* Booth Styling */
        .booth-group { margin-bottom: 25px; }
        .booth-header { background: #1e293b; color: white; padding: 12px 15px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .booth-header span { font-weight: bold; }
        .booth-header small { background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 6px; font-size: 0.75rem; }

        /* Desktop Table (Hide on Mobile) */
        .stock-table { width: 100%; border-collapse: collapse; background: white; display: table; }
        .stock-table th, .stock-table td { padding: 12px; text-align: left; border-bottom: 1px solid #f1f5f9; }
        .stock-table th { background: #f8fafc; font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; }

        /* Mobile Card Style (Hide on Desktop) */
        .stock-item-card { background: white; padding: 15px; border-bottom: 1px solid #f1f5f9; display: none; flex-direction: column; gap: 10px; }
        .stock-item-card:last-child { border-radius: 0 0 12px 12px; border-bottom: none; }

        .item-info { display: flex; justify-content: space-between; align-items: flex-start; }
        .item-name { font-weight: bold; color: #1e293b; font-size: 1rem; }
        .qty-badge { background: #f0fdf4; color: #166534; padding: 4px 10px; border-radius: 8px; font-weight: bold; border: 1px solid #dcfce7; }
        
        .action-area { display: flex; align-items: center; gap: 10px; background: #f8fafc; padding: 10px; border-radius: 10px; }
        .input-pack { flex: 1; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; text-align: center; font-size: 1rem; font-weight: bold; }
        .btn-add { background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; white-space: nowrap; }

        /* Responsive Breakpoints */
        @media (max-width: 640px) {
            .stock-table { display: none; } /* ‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            .stock-item-card { display: flex; } /* ‡πÇ‡∏ä‡∏ß‡πå‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏ó‡∏ô */
            .header-section { flex-direction: column; align-items: flex-start; }
            .btn-report { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-section">
        <h2>üì¶ ‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
        <a href="inventory_report.html" class="btn btn-report">üìä ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å</a>
    </div>

    <a href="stock_transfer.html" class="btn btn-transfer">
        <span>üîÑ ‡πÇ‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏π‡∏ò</span>
    </a>

    <div class="filter-bar">
        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô (Event)</label>
        <select id="event-select" onchange="loadInventoryByBooth()">
            <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô --</option>
        </select>
    </div>

    <div id="booth-container">
        </div>
</div>

<script>
    async function init() {
        const { data: events } = await _supabase.from('events').select('*');
        const select = document.getElementById('event-select');
        events.forEach(ev => {
            const opt = document.createElement('option');
            opt.value = ev.id;
            opt.innerText = ev.event_name;
            select.appendChild(opt);
        });
    }

    async function loadInventoryByBooth() {
        const evId = document.getElementById('event-select').value;
        if (!evId) return;

        const { data, error } = await _supabase
            .from('booth_inventory')
            .select(`
                stock_qty, booth_id, product_id,
                booths!inner(booth_name, event_id),
                products(name, items_per_pack)
            `)
            .eq('booths.event_id', evId)
            .order('booth_id');

        if (error) return console.error(error);

        const grouped = data.reduce((acc, item) => {
            const bName = item.booths.booth_name;
            if (!acc[bName]) acc[bName] = [];
            acc[bName].push(item);
            return acc;
        }, {});

        const container = document.getElementById('booth-container');
        container.innerHTML = '';

        for (const boothName in grouped) {
            const items = grouped[boothName];
            const section = document.createElement('div');
            section.className = 'booth-group';
            
            section.innerHTML = `
                <div class="booth-header">
                    <span>üè™ ${boothName}</span>
                    <small>${items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</small>
                </div>
                <table class="stock-table">
                    <thead>
                        <tr>
                            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                            <th>‡πÅ‡∏û‡πá‡∏Ñ‡∏•‡∏∞</th>
                            <th>‡πÄ‡∏ï‡∏¥‡∏° (‡πÅ‡∏û‡πá‡∏Ñ)</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map(item => `
                            <tr>
                                <td><strong>${item.products.name}</strong></td>
                                <td><span class="qty-badge">${item.stock_qty}</span></td>
                                <td>${item.products.items_per_pack}</td>
                                <td><input type="number" class="input-pack" id="in-d-${item.booth_id}-${item.product_id}" placeholder="0"></td>
                                <td><button class="btn-add" onclick="addStock('${item.booth_id}', '${item.product_id}', 'd')">‚ûï ‡πÄ‡∏ï‡∏¥‡∏°</button></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <div class="mobile-list">
                    ${items.map(item => `
                        <div class="stock-item-card">
                            <div class="item-info">
                                <div class="item-name">${item.products.name}</div>
                                <div class="qty-badge">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${item.stock_qty}</div>
                            </div>
                            <div style="font-size: 0.75rem; color: #64748b;">‡∏ö‡∏£‡∏£‡∏à‡∏∏: ${item.products.items_per_pack} ‡∏ä‡∏¥‡πâ‡∏ô/‡πÅ‡∏û‡πá‡∏Ñ</div>
                            <div class="action-area">
                                <input type="number" class="input-pack" id="in-m-${item.booth_id}-${item.product_id}" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏û‡πá‡∏Ñ">
                                <button class="btn-add" onclick="addStock('${item.booth_id}', '${item.product_id}', 'm')">‚ûï ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡∏≠‡∏á</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            container.appendChild(section);
        }
    }

    async function addStock(bId, pId, mode) {
        const inputId = mode === 'm' ? `in-m-${bId}-${pId}` : `in-d-${bId}-${pId}`;
        const input = document.getElementById(inputId);
        const packs = parseInt(input.value);
        if (!packs || packs <= 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏û‡πá‡∏Ñ");

        const { error } = await _supabase.rpc('add_stock_by_pack', {
            p_booth_id: bId,
            p_product_id: pId,
            p_packs_count: packs
        });

        if (!error) {
            if (window.navigator.vibrate) window.navigator.vibrate(50);
            alert("‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
            input.value = '';
            loadInventoryByBooth();
        } else {
            alert("Error: " + error.message);
        }
    }

    init();
</script>
</body>
</html>