<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ö‡∏π‡∏ò</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../config.js" type="text/javascript"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #e67e22; }
        body { font-family: 'Sarabun', sans-serif; background: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; }
        
        /* ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ö‡∏π‡∏ò */
        .booth-summary-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .booth-card { background: white; padding: 15px; border-radius: 12px; border-left: 5px solid var(--accent);}
        .booth-card h4 { margin: 0 0 10px 0; color: var(--primary); }
        .booth-stat { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 5px; }

        .filter-bar { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; gap: 15px; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .table-container { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: var(--primary); color: white; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; color: white; }
    </style>
</head>
<body>

<div class="container">
    
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h1>
        <button onclick="fetchData()" style="padding: 10px 20px; cursor: pointer; border-radius: 8px; border: 1px solid #ddd;">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>

    <div class="filter-bar">
        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô (Event):</label>
        <select id="event-select" onchange="fetchData()">
            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏∏‡∏Å‡∏á‡∏≤‡∏ô</option>
        </select>
    </div>
    <div class="summary-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div class="card" style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center;">
            <h3 style="margin: 0; color: #666; font-size: 0.9rem;">üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏á‡∏≤‡∏ô (Event Total)</h3>
            <p id="sum-total" style="margin: 10px 0 0; font-size: 2rem; font-weight: bold; color: #2c3e50;">0</p>
        </div>
        <div class="card" style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center;">
            <h3 style="margin: 0; color: #666; font-size: 0.9rem;">üíµ ‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î (Total Cash)</h3>
            <p id="sum-cash" style="margin: 10px 0 0; font-size: 2rem; font-weight: bold; color: #27ae60;">0</p>
        </div>
        <div class="card" style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center;">
            <h3 style="margin: 0; color: #666; font-size: 0.9rem;">üì± ‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô (Total QR)</h3>
            <p id="sum-qr" style="margin: 10px 0 0; font-size: 2rem; font-weight: bold; color: #2980b9;">0</p>
        </div>
    </div>
    <h3 style="margin-bottom: 15px;">üèÅ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ö‡∏π‡∏ò</h3>
    <div id="booth-summary-list" class="booth-summary-grid">
        </div>

    <h3 style="margin-bottom: 15px;">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏π‡∏ò</th>
                    <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                    <th>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                    <th>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th>
                </tr>
            </thead>
            <tbody id="sales-table"></tbody>
        </table>
    </div>
</div>

<script>
    async function init() {
        const { data: events } = await _supabase.from('events').select('*');
        const select = document.getElementById('event-select');
        events.forEach(ev => {
            const opt = document.createElement('option');
            opt.value = ev.id;
            opt.innerText = ev.event_name;
            select.appendChild(opt);
        });
        fetchData();
    }

       async function fetchData() {
            const evId = document.getElementById('event-select').value;
            
            // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å View ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß
            let query = _supabase.from('v_sales_report').select('*');
            if (evId !== 'all') query = query.eq('event_id', evId);

            const { data: reportData, error: err1 } = await query;
            if (err1) return console.error(err1);

            // 2. ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ä‡∏ß‡πå‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ 50 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏û‡∏≠)
            let historyQuery = _supabase
                .from('sales_transactions')
                .select(`*, booths(booth_name)`)
                .order('sold_at', { ascending: false })
                .limit(50);
            if (evId !== 'all') historyQuery = historyQuery.eq('event_id', evId);
            
            const { data: historyData } = await historyQuery;

            // --- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏° (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å View) ---
            let totalEventCash = 0;
            let totalEventQr = 0;
            const boothStats = {};

            reportData.forEach(row => {
                const amt = Number(row.total_sum);
                
                // ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° Event
                if (row.payment_method === 'cash') totalEventCash += amt;
                else totalEventQr += amt;

                // ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏ö‡∏π‡∏ò
                if (!boothStats[row.booth_id]) {
                    boothStats[row.booth_id] = { name: row.booth_name, cash: 0, qr: 0, total: 0 };
                }
                if (row.payment_method === 'cash') boothStats[row.booth_id].cash += amt;
                else boothStats[row.booth_id].qr += amt;
                boothStats[row.booth_id].total += amt;
            });

            // --- ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• UI (‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏£‡∏≤‡∏¢‡∏ö‡∏π‡∏ò) ---
            document.getElementById('sum-cash').innerText = totalEventCash.toLocaleString();
            document.getElementById('sum-qr').innerText = totalEventQr.toLocaleString();
            document.getElementById('sum-total').innerText = (totalEventCash + totalEventQr).toLocaleString();

            document.getElementById('booth-summary-list').innerHTML = Object.values(boothStats).map(b => `
                <div class="booth-card">
                    <h4>üè™ ${b.name}</h4>
                    <div class="booth-stat"><span>‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î:</span> <b>${b.cash.toLocaleString()}</b></div>
                    <div class="booth-stat"><span>‡πÇ‡∏≠‡∏ô/QR:</span> <b>${b.qr.toLocaleString()}</b></div>
                    <div class="booth-stat font-bold border-t mt-1 pt-1 text-orange-600">
                        <span>‡∏£‡∏ß‡∏°:</span> <b>${b.total.toLocaleString()}.-</b>
                    </div>
                </div>
            `).join('');

            // --- ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å historyData) ---
            renderSalesTable(historyData); 
        }   
        init();
</script>
</body>
</html>