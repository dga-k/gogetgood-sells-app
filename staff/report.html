<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ö‡∏π‡∏ò</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../config.js" type="text/javascript"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #e67e22; }
        body { font-family: 'Sarabun', sans-serif; background: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; }
        
        /* ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ö‡∏π‡∏ò */
        .booth-summary-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .booth-card { background: white; padding: 15px; border-radius: 12px; border-left: 5px solid var(--accent);}
        .booth-card h4 { margin: 0 0 10px 0; color: var(--primary); }
        .booth-stat { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 5px; }

        .filter-bar { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; gap: 15px; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .table-container { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: var(--primary); color: white; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; color: white; }
    </style>
</head>
<body>

<div class="container">
    
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h1>
        <button onclick="fetchData()" style="padding: 10px 20px; cursor: pointer; border-radius: 8px; border: 1px solid #ddd;">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>

    <div class="filter-bar">
        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô (Event):</label>
        <select id="event-select" onchange="fetchData()">
            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏∏‡∏Å‡∏á‡∏≤‡∏ô</option>
        </select>
    </div>
    <div class="summary-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div class="card" style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center;">
            <h3 style="margin: 0; color: #666; font-size: 0.9rem;">üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏á‡∏≤‡∏ô (Event Total)</h3>
            <p id="sum-total" style="margin: 10px 0 0; font-size: 2rem; font-weight: bold; color: #2c3e50;">0</p>
        </div>
        <div class="card" style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center;">
            <h3 style="margin: 0; color: #666; font-size: 0.9rem;">üíµ ‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î (Total Cash)</h3>
            <p id="sum-cash" style="margin: 10px 0 0; font-size: 2rem; font-weight: bold; color: #27ae60;">0</p>
        </div>
        <div class="card" style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center;">
            <h3 style="margin: 0; color: #666; font-size: 0.9rem;">üì± ‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô (Total QR)</h3>
            <p id="sum-qr" style="margin: 10px 0 0; font-size: 2rem; font-weight: bold; color: #2980b9;">0</p>
        </div>
    </div>
    <h3 style="margin-bottom: 15px;">üèÅ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ö‡∏π‡∏ò</h3>
    <div id="booth-summary-list" class="booth-summary-grid">
        </div>

    <h3 style="margin-bottom: 15px;">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏π‡∏ò</th>
                    <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                    <th>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                    <th>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th>
                </tr>
            </thead>
            <tbody id="sales-table"></tbody>
        </table>
    </div>
</div>

<script>
    async function init() {
        const { data: events } = await _supabase.from('events').select('*');
        const select = document.getElementById('event-select');
        events.forEach(ev => {
            const opt = document.createElement('option');
            opt.value = ev.id;
            opt.innerText = ev.event_name;
            select.appendChild(opt);
        });
        fetchData();
    }

    async function fetchData() {
    const evId = document.getElementById('event-select').value;
    
    let query = _supabase
        .from('sales_transactions')
        .select(`*, booths(booth_name)`)
        .order('sold_at', { ascending: false });
    
    if (evId !== 'all') query = query.eq('event_id', evId);

    const { data, error } = await query;
    if (error) return console.error(error);

    // --- ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ---
    let totalEventCash = 0;
    let totalEventQr = 0;
    const boothStats = {};

    data.forEach(s => {
        const bName = s.booths ? s.booths.booth_name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
        const bId = s.booth_id;
        const amt = Number(s.amount);

        // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° Event (‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏ö‡∏π‡∏ò)
        if (s.payment_method === 'cash') totalEventCash += amt;
        else totalEventQr += amt;

        // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡∏ö‡∏π‡∏ò
        if (!boothStats[bId]) {
            boothStats[bId] = { name: bName, cash: 0, qr: 0, total: 0 };
        }
        if (s.payment_method === 'cash') boothStats[bId].cash += amt;
        else boothStats[bId].qr += amt;
        boothStats[bId].total += amt;
    });

    // --- ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° Event ---
    document.getElementById('sum-cash').innerText = totalEventCash.toLocaleString();
    document.getElementById('sum-qr').innerText = totalEventQr.toLocaleString();
    document.getElementById('sum-total').innerText = (totalEventCash + totalEventQr).toLocaleString();

    // --- ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡∏ö‡∏π‡∏ò ---
    const summaryDiv = document.getElementById('booth-summary-list');
    summaryDiv.innerHTML = Object.values(boothStats).map(b => `
        <div class="booth-card">
            <h4>üè™ ${b.name}</h4>
            <div class="booth-stat"><span>‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î:</span> <b>${b.cash.toLocaleString()}</b></div>
            <div class="booth-stat"><span>‡πÇ‡∏≠‡∏ô/QR:</span> <b>${b.qr.toLocaleString()}</b></div>
            <div class="booth-stat" style="color: #e67e22; font-weight:bold; border-top: 1px solid #eee; margin-top:5px; padding-top:5px;">
                <span>‡∏£‡∏ß‡∏°:</span> <b>${b.total.toLocaleString()}.-</b>
            </div>
        </div>
    `).join('');

    // --- ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
    const tableBody = document.getElementById('sales-table');
    tableBody.innerHTML = data.map(s => `
        <tr>
            <td>${new Date(s.sold_at).toLocaleTimeString('th-TH')}</td>
            <td><strong>${s.booths ? s.booths.booth_name : 'N/A'}</strong></td>
            <td>${s.product_name}</td>
            <td>${Number(s.amount).toLocaleString()}</td>
            <td>
                <span class="badge" style="background: ${s.payment_method === 'cash' ? '#27ae60' : '#2980b9'}">
                    ${s.payment_method === 'cash' ? 'Cash' : 'QR'}
                </span>
            </td>
        </tr>
    `).join('');
}

    init();
</script>
</body>
</html>