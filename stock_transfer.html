<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÇ‡∏≠‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏π‡∏ò</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>body { font-family: 'Sarabun', sans-serif; }</style>
</head>
<body class="bg-slate-50 p-4">
    <div class="max-w-md mx-auto">
        <div class="bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100">
            <div class="bg-amber-500 p-6 text-white text-center">
                <h2 class="text-2xl font-black italic">üîÑ STOCK TRANSFER</h2>
                <p class="text-[10px] opacity-90 uppercase mt-1">‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏π‡∏ò‡πÉ‡∏ô‡∏á‡∏≤‡∏ô</p>
            </div>

            <div class="p-6 space-y-5">
                <div>
                    <label class="block text-[11px] font-black text-amber-600 uppercase mb-2">üö© ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå</label>
                    <select id="event-select" onchange="handleEventChange()" class="w-full p-4 bg-amber-50 border-2 border-amber-100 rounded-2xl focus:border-amber-500 outline-none transition-all font-bold text-slate-700">
                        <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô --</option>
                    </select>
                </div>

                <hr class="border-slate-100">

                <div>
                    <label class="block text-[11px] font-bold text-slate-400 uppercase mb-1 ml-1">üì§ ‡∏ö‡∏π‡∏ò‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á (‡∏ú‡∏π‡πâ‡πÇ‡∏≠‡∏ô)</label>
                    <select id="from-booth" onchange="loadSourceProducts()" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none font-bold" disabled>
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏π‡∏ò‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á --</option>
                    </select>
                </div>

                <div>
                    <label class="block text-[11px] font-bold text-slate-400 uppercase mb-1 ml-1">üì¶ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÇ‡∏≠‡∏ô</label>
                    <select id="product-select" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none font-bold text-sm" disabled>
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>
                    </select>
                </div>

                <div>
                    <label class="block text-[11px] font-bold text-slate-400 uppercase mb-1 ml-1">üî¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô</label>
                    <input type="number" id="transfer-qty" placeholder="0" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none font-black text-lg text-amber-600">
                </div>

                <div>
                    <label class="block text-[11px] font-bold text-slate-400 uppercase mb-1 ml-1">üì• ‡∏ö‡∏π‡∏ò‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö)</label>
                    <select id="to-booth" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none font-bold" disabled>
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏π‡∏ò‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á --</option>
                    </select>
                </div>

                <button onclick="transferStock()" id="btn-transfer" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-black shadow-lg active:scale-95 transition-all mt-4 text-lg">
                    ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                </button>
            </div>
        </div>
        
        <div class="text-center mt-6">
            <a href="admin_dashboard.html" class="text-slate-400 text-sm font-bold">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</a>
        </div>
    </div>

    <script>
        async function init() {
            // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Event ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô Select
            const { data: events } = await _supabase.from('events').select('id, event_name').order('id', { ascending: false });
            const eventSelect = document.getElementById('event-select');
            
            events.forEach(ev => {
                eventSelect.innerHTML += `<option value="${ev.id}">${ev.event_name}</option>`;
            });

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ event_id ‡πÉ‡∏ô URL ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            const params = new URLSearchParams(window.location.search);
            const evId = params.get('event_id');
            if (evId) {
                eventSelect.value = evId;
                handleEventChange();
            }
        }

        async function handleEventChange() {
            const evId = document.getElementById('event-select').value;
            const fromSelect = document.getElementById('from-booth');
            const toSelect = document.getElementById('to-booth');
            const pSelect = document.getElementById('product-select');

            // Reset ‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÜ
            fromSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏π‡∏ò‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á --</option>';
            toSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏π‡∏ò‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á --</option>';
            pSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>';
            
            if (!evId) {
                fromSelect.disabled = toSelect.disabled = true;
                return;
            }

            // ‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏π‡∏ò‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á Event ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            const { data: booths } = await _supabase.from('booths').select('id, booth_name').eq('event_id', evId).order('booth_name');
            
            booths.forEach(b => {
                let opt = `<option value="${b.id}">${b.booth_name}</option>`;
                fromSelect.innerHTML += opt;
                toSelect.innerHTML += opt;
            });

            fromSelect.disabled = toSelect.disabled = false;
        }

        async function loadSourceProducts() {
            const bId = document.getElementById('from-booth').value;
            const pSelect = document.getElementById('product-select');
            
            if (!bId) {
                pSelect.disabled = true;
                return;
            }

            pSelect.innerHTML = '<option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å... --</option>';
            pSelect.disabled = false;

            const { data } = await _supabase
                .from('booth_inventory')
                .select('product_id, stock_qty, products(name)')
                .eq('booth_id', bId)
                .gt('stock_qty', 0);

            pSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>';
            data.forEach(item => {
                pSelect.innerHTML += `<option value="${item.product_id}">${item.products.name} (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${item.stock_qty})</option>`;
            });
        }

        async function transferStock() {
            const evId = document.getElementById('event-select').value;
            const fromB = document.getElementById('from-booth').value;
            const toB = document.getElementById('to-booth').value;
            const prod = document.getElementById('product-select').value;
            const qty = parseInt(document.getElementById('transfer-qty').value);

            if (!evId || !fromB || !toB || !prod || !qty || qty <= 0) {
                return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
            }
            if (fromB === toB) {
                return alert("‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏•‡∏∞‡∏ö‡∏π‡∏ò‡∏Å‡∏±‡∏ô");
            }

            const btn = document.getElementById('btn-transfer');
            btn.disabled = true;
            btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...";

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å RPC ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏£‡∏±‡∏ö p_event_id ‡πÑ‡∏ß‡πâ
            const { error } = await _supabase.rpc('handle_stock_transfer', {
                p_event_id: evId,
                p_from_booth_id: fromB,
                p_to_booth_id: toB,
                p_product_id: prod,
                p_qty: qty
            });

            if (!error) {
                alert("‚úÖ ‡πÇ‡∏≠‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                loadSourceProducts(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                document.getElementById('transfer-qty').value = '';
            } else {
                alert("‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
            }
            
            btn.disabled = false;
            btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤";
        }

        init();
    </script>
</body>
</html>